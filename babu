pipeline {
    agent any

    environment {
        AWS_REGION  = "ap-south-1"
        AWS_ACCOUNT = "628253046406"
        ECR_REPO    = "diary-backend"
        IMAGE_NAME  = "diary-backend"
        IMAGE_TAG   = "${BUILD_NUMBER}"

        EC2_HOST = "13.232.103.44"
        EC2_USER = "ubuntu"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }

        stage('Login to ECR') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'aws-creds',
                        usernameVariable: 'AWS_ACCESS_KEY_ID',
                        passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                    )
                ]) {
                    sh """
                    aws ecr get-login-password --region ${AWS_REGION} \
                    | docker login --username AWS --password-stdin \
                    ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com
                    """
                }
            }
        }

        stage('Push Image to ECR') {
            steps {
                sh """
                docker tag ${IMAGE_NAME}:${IMAGE_TAG} \
                  ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}

                docker tag ${IMAGE_NAME}:${IMAGE_TAG} \
                  ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest

                docker push ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}
                docker push ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest
                """
            }
        }

        stage('Deploy (True Blue/Green – Zero Downtime)') {
            steps {
                sshagent(['ec2-ssh-key']) {
                    sh """
ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
set -e

cd /opt/diary-deploy

# Detect active container
if docker ps --format '{{.Names}}' | grep -q diary-backend-green; then
    ACTIVE_COLOR="green"
    ACTIVE_PORT=8002
    NEW_COLOR="blue"
    NEW_PORT=8001
else
    ACTIVE_COLOR="blue"
    ACTIVE_PORT=8001
    NEW_COLOR="green"
    NEW_PORT=8002
fi

echo "▶ Active: \$ACTIVE_COLOR on port \$ACTIVE_PORT"
echo "▶ Deploying: \$NEW_COLOR on port \$NEW_PORT"

# Pull latest image
docker pull ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest

# Start new container
docker compose -f docker-compose.\$NEW_COLOR.yml up -d --force-recreate

# Health check
echo "▶ Waiting for \$NEW_COLOR health"
for i in {1..30}; do
  if curl -fs http://localhost:\$NEW_PORT/health > /dev/null; then
    echo "✔ \$NEW_COLOR is healthy"
    break
  fi
  sleep 2
done

# Switch Nginx traffic
echo "▶ Switching Nginx to port \$NEW_PORT"

sudo tee /etc/nginx/conf.d/diary.conf > /dev/null <<NGINX
server {
    listen 80;

    location / {
        proxy_pass http://127.0.0.1:\$NEW_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
}
NGINX

sudo nginx -t
sudo systemctl reload nginx

# Stop old container
echo "▶ Stopping \$ACTIVE_COLOR container"
docker stop diary-backend-\$ACTIVE_COLOR || true
docker rm diary-backend-\$ACTIVE_COLOR || true

echo "✔ Zero-downtime deployment complete"
EOF
"""
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment completed with zero downtime"
        }
        failure {
            echo "❌ Deployment failed — review logs"
        }
    }
}
