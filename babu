pipeline {
    agent any

    environment {
        AWS_REGION  = "ap-south-1"
        AWS_ACCOUNT = "628253046406"
        ECR_REPO    = "diary-backend"
        IMAGE_NAME  = "diary-backend"
        IMAGE_TAG   = "${BUILD_NUMBER}"
        EC2_HOST    = "13.232.103.44"
        EC2_USER    = "ubuntu"

        BLUE_PORT  = "8001"
        GREEN_PORT = "8002"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }

        stage('Login to ECR') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'aws-creds',
                        usernameVariable: 'AWS_ACCESS_KEY_ID',
                        passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                    )
                ]) {
                    sh """
                    aws ecr get-login-password --region ${AWS_REGION} |
                    docker login --username AWS --password-stdin \
                    ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com
                    """
                }
            }
        }

        stage('Push Image to ECR') {
            steps {
                sh """
                docker tag ${IMAGE_NAME}:${IMAGE_TAG} \
                  ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}

                docker tag ${IMAGE_NAME}:${IMAGE_TAG} \
                  ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest

                docker push ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}
                docker push ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest
                """
            }
        }

        stage('Deploy (True Blue/Green)') {
            steps {
                sshagent(['ec2-ssh-key']) {
                    sh """
ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
set -e

cd /opt/diary-deploy

# Detect active color
if docker ps --format '{{.Names}}' | grep -q diary-backend-blue; then
  ACTIVE=blue
  ACTIVE_PORT=${BLUE_PORT}
  NEW=green
  NEW_PORT=${GREEN_PORT}
else
  ACTIVE=green
  ACTIVE_PORT=${GREEN_PORT}
  NEW=blue
  NEW_PORT=${BLUE_PORT}
fi

echo "▶ Active: \$ACTIVE on port \$ACTIVE_PORT"
echo "▶ Deploying: \$NEW on port \$NEW_PORT"

docker pull ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest

docker compose -f docker-compose.\$NEW.yml up -d --force-recreate

echo "▶ Waiting for \$NEW health"
for i in {1..30}; do
  if curl -fs http://localhost:\$NEW_PORT/health > /dev/null; then
    echo "✔ \$NEW is healthy"
    break
  fi
  sleep 2
done

echo "▶ Switching Nginx to \$NEW_PORT"
sudo bash -c "cat > /etc/nginx/conf.d/diary.conf << NGINX
server {
    listen 80;
    location / {
        proxy_pass http://127.0.0.1:\$NEW_PORT;
        proxy_set_header Host \\\$host;
        proxy_set_header X-Real-IP \\\$remote_addr;
        proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;
    }
}
NGINX"

sudo nginx -t
sudo systemctl reload nginx

echo "▶ Stopping \$ACTIVE"
docker stop diary-backend-\$ACTIVE || true
docker rm diary-backend-\$ACTIVE || true

echo "✔ Zero-downtime deployment completed"
EOF
"""
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment completed with ZERO downtime"
        }
        failure {
            echo "❌ Deployment failed"
        }
    }
}
