pipeline {
    agent any

    environment {
        AWS_REGION  = "ap-south-1"
        AWS_ACCOUNT = "628253046406"
        ECR_REPO    = "diary-backend"
        IMAGE_NAME  = "diary-backend"
        IMAGE_TAG   = "${BUILD_NUMBER}"
        EC2_HOST    = "13.232.103.44"
        EC2_USER    = "ubuntu"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }

        stage('Login to ECR') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'aws-creds',
                        usernameVariable: 'AWS_ACCESS_KEY_ID',
                        passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                    )
                ]) {
                    sh """
                    aws ecr get-login-password --region ${AWS_REGION} \
                    | docker login --username AWS --password-stdin \
                    ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com
                    """
                }
            }
        }

        stage('Push Image to ECR') {
            steps {
                sh """
                docker tag ${IMAGE_NAME}:${IMAGE_TAG} \
                  ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}

                docker tag ${IMAGE_NAME}:${IMAGE_TAG} \
                  ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest

                docker push ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}
                docker push ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest
                """
            }
        }

        stage('Deploy (Single Instance Blue/Green)') {
            steps {
                sshagent(['ec2-ssh-key']) {
                    sh """
ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
set -e

echo "▶ Preparing deployment directory"
sudo mkdir -p /opt/diary-deploy
sudo chown -R ${EC2_USER}:${EC2_USER} /opt/diary-deploy
cd /opt/diary-deploy

echo "▶ Pulling latest image"
docker pull ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest

echo "▶ Starting GREEN container"
docker compose -f docker-compose.green.yml up -d --force-recreate

echo "▶ Waiting for GREEN health"
for i in {1..30}; do
  if curl -fs http://localhost:8001/health > /dev/null; then
    echo "✔ GREEN is healthy"
    break
  fi
  sleep 2
done

echo "▶ Writing Nginx config"
sudo bash -c 'cat > /etc/nginx/conf.d/diary.conf << "NGINX"
server {
    listen 80;

    location / {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
}
NGINX'

sudo nginx -t
sudo systemctl reload nginx

echo "▶ Cleaning BLUE container (if exists)"
docker stop diary-backend-blue || true
docker rm diary-backend-blue || true

echo "✔ Deployment successful"
EOF
"""
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment completed with near-zero downtime"
        }
        failure {
            echo "❌ Pipeline failed — review logs"
        }
    }
}
