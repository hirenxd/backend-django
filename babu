pipeline {
    agent any

    environment {
        AWS_REGION = "ap-south-1"
        AWS_ACCOUNT_ID = "628253046406"
        IMAGE_NAME = "diary-backend"
        IMAGE_TAG  = "${BUILD_NUMBER}"
        ECR_REPO   = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}"
        EC2_USER   = "ubuntu"
        EC2_HOST   = "13.232.103.44"
        DEPLOY_DIR = "/opt/diary-deploy"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                sh """
                  docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                """
            }
        }

        stage('Login to ECR') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'aws-creds',
                        usernameVariable: 'AWS_ACCESS_KEY_ID',
                        passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                    )
                ]) {
                    sh """
                      aws ecr get-login-password --region ${AWS_REGION} \
                      | docker login --username AWS --password-stdin ${ECR_REPO}
                    """
                }
            }
        }

        stage('Push Image to ECR') {
            steps {
                sh """
                  docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${ECR_REPO}:${IMAGE_TAG}
                  docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${ECR_REPO}:latest
                  docker push ${ECR_REPO}:${IMAGE_TAG}
                  docker push ${ECR_REPO}:latest
                """
            }
        }

        stage('Deploy (Zero-Downtime, Single Instance)') {
            steps {
                sshagent(['ubuntu']) {
                    sh """
                      ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
                      set -e

                      echo "▶ Preparing deployment directory"
                      sudo mkdir -p ${DEPLOY_DIR}
                      sudo chown -R ubuntu:ubuntu ${DEPLOY_DIR}
                      cd ${DEPLOY_DIR}

                      echo "▶ Pulling latest image"
                      docker pull ${ECR_REPO}:latest

                      echo "▶ Starting GREEN container"
                      docker compose -f docker-compose.green.yml up -d --force-recreate

                      echo "▶ Waiting for app health"
                      for i in {1..30}; do
                        if curl -fs http://localhost:8001/health > /dev/null; then
                          echo "✔ GREEN is healthy"
                          break
                        fi
                        sleep 2
                      done

                      echo "▶ Switching Nginx traffic"
                      sudo tee /etc/nginx/conf.d/diary.conf > /dev/null << 'NGINX'
server {
    listen 80;

    location / {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
}
NGINX

                      sudo nginx -t
                      sudo systemctl reload nginx

                      echo "▶ Stopping BLUE container (if exists)"
                      docker stop diary-backend-blue || true
                      docker rm diary-backend-blue || true

                      echo "✔ Deployment successful"
                      EOF
                    """
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment completed successfully"
        }
        failure {
            echo "❌ Deployment failed. Traffic was not switched."
        }
    }
}
